@model List<ProyectoIdentity.Models.Producto>
@{
    ViewBag.Title = "Personalización de productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* --------- Menú de Categorías --------- */
    .category-nav {
        position: sticky;
        top: 0;
        background: #fff;
        padding: 8px 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        z-index: 100;
    }

    .category-container {
        display: flex;
        overflow-x: auto;
        gap: 16px;
        padding: 0 24px;
        scroll-behavior: smooth;
        justify-content: center;
        margin: 0 auto;
        max-width: 900px; 
    }
    .category-container::-webkit-scrollbar { height:6px; }
    .category-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius:3px; }
    
    .category-btn {
        flex:0 0 auto; display:flex; flex-direction:column; align-items:center;
        border:none; background:transparent; cursor:pointer;
        padding:6px 12px; transition:color .2s,transform .2s; color:#555;
        text-decoration: none !important;
    }
    .category-btn i { font-size:1.4rem; margin-bottom:4px; transition:transform .2s; }
    .category-btn span { font-size:.85rem; white-space:nowrap; }
    .category-btn.active,
    .category-btn:hover { color:#28a745; transform:translateY(-3px); text-decoration: none !important; }
    .category-btn.active i,
    .category-btn:hover i { transform:scale(1.2); }
    .category-btn.active::after {
        content:''; display:block; width:100%; height:3px;
        background:linear-gradient(90deg,#ffc107,#28a745);
        border-radius:2px; margin-top:6px; animation:indicator-in .3s ease-out;
    }
    @@keyframes indicator-in { from{width:0} to{width:100%} }
    @@media(max-width:576px){ .category-btn i{font-size:1.2rem} .category-btn span{font-size:.75rem} }

    /* --------- Grid de Productos --------- */
    .product-grid {
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
        gap:24px;
        margin:24px 0;
    }
    .product-card {
        background:#fff; border-radius:12px; overflow:hidden;
        box-shadow:0 4px 12px rgba(0,0,0,0.08);
        transition:transform .3s,box-shadow .3s; position:relative;
        height: 100%;
    }
    .product-card:hover { transform:translateY(-5px); box-shadow:0 8px 24px rgba(0,0,0,0.1); }
    .product-card img {
        width:100%; height:180px; object-fit:cover;
    }
    .card-body {
        padding:16px; text-align:center; display: flex; flex-direction: column; height: calc(100% - 180px);
    }
    .product-name {
        font-size:1.15rem; font-weight:600; color:#212529; margin:8px 0 4px;
    }
    .product-price {
        font-size:1rem; font-weight:700; color:#e83e8c; margin-bottom:8px;
    }
    .product-description {
        font-size:0.9rem; color:#6c757d; margin-bottom:12px; flex-grow: 1;
    }
    
    /* ✅ Estilos para los botones con validaciones */
    .btn-seleccionar {
        background-color: #F2A900;
        border-color: #F2A900;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: inline-block;
        width: 100%;
        text-decoration: none !important;
        cursor: pointer;
    }

    .btn-seleccionar:hover:not(:disabled) {
        background-color: #e09600;
        border-color: #d48e00;
        color: #fff;
        transform: translateY(-2px);
        text-decoration: none !important;
    }

    .btn-seleccionar:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        color: #fff;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-seleccionar.btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #212529;
    }

    .btn-seleccionar.btn-warning:hover {
        background-color: #e0a800;
        border-color: #d39e00;
        color: #212529;
    }

    .btn-seleccionar i {
        margin-right: 5px;
    }

    /* ✅ Estilos para información de límites */
    .points-info {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 5px;
        border-left: 3px solid #28a745;
        margin-bottom: 12px;
        font-size: 0.85rem;
    }
</style>

<h1 class="text-center mt-4">@(string.IsNullOrEmpty(ViewBag.CategoriaActual) || ViewBag.CategoriaActual.ToLower() == "todas" ? "Personalización de productos" : $"{ViewBag.CategoriaActual} - Personalizable")</h1>

<!-- ✅ ESTADO UNIFICADO DE PRODUCTOS -->
<div class="container mt-4">
    <div id="estado-unificado" class="alert alert-info" style="display: none;">
        <h6><i class="fas fa-info-circle"></i> Estado unificado de productos</h6>
        <div class="row">
            <div class="col-md-4">
                <strong>Disponibles:</strong> <span id="disponibles-count">-</span> producto(s) más
            </div>
            <div class="col-md-4">
                <strong>En pedidos activos:</strong> <span id="activos-count">-</span>
            </div>
            <div class="col-md-4">
                <strong>En ambos carritos:</strong> <span id="carritos-count">-</span> productos
            </div>
        </div>
        <small class="text-muted d-block mt-2">
            <em>Límite compartido entre personalización y recomendación IA: <span id="limite-info">0/3</span> productos</em>
        </small>
    </div>
</div>

<nav class="category-nav">
    <div class="category-container">
        <a href="@Url.Action("Index", new { categoria = "todas" })" 
           class="category-btn @(ViewBag.CategoriaActual?.ToLower() == "todas" ? "active" : "")">
            <i class="fas fa-layer-group"></i>
            <span>Todas</span>
        </a>
        @if (ViewBag.Categorias != null)
        {
            @foreach (var categoria in ViewBag.Categorias)
            {
                <a href="@Url.Action("Index", new { categoria = categoria })" 
                   class="category-btn @(ViewBag.CategoriaActual?.ToLower() == categoria.ToLower() ? "active" : "")">
                    <i class="@GetCategoryIcon(categoria)"></i>
                    <span>@categoria</span>
                </a>
            }
        }
    </div>
</nav>

<div class="container">
    <div class="product-grid">
        @if (Model.Any())
        {
            @foreach (var producto in Model)
            {
                <div class="product-card" data-categoria="@producto.Categoria.ToLower()">
                    @if (producto.Imagen != null)
                    {
                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(producto.Imagen)"
                             alt="@producto.Nombre" />
                    }
                    else
                    {
                        <img src="https://via.placeholder.com/260x180/f8f9fa/6c757d?text=Sin+Imagen"
                             alt="@producto.Nombre" />
                    }
                    <div class="card-body">
                        <div class="product-name">@producto.Nombre</div>
                        <div class="product-price">$@producto.Precio.ToString("F2")</div>
                        <p class="product-description">@producto.Descripcion</p>
                        
                        <div class="points-info">
                            <small class="text-success">
                                <i class="fas fa-star"></i> Ganas @((int)(producto.Precio * 30)) puntos
                            </small>
                        </div>
                        
                        <div class="mt-auto">
                            <!-- ✅ BOTÓN CON VALIDACIÓN DE LÍMITES -->
                            <button type="button" 
                                    class="btn-seleccionar" 
                                    data-producto-id="@producto.Id"
                                    onclick="validarYSeleccionar(@producto.Id)">
                                <i class="fas fa-cog"></i> Personalizar
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>No hay productos disponibles</h5>
                    <p>No se encontraron productos para la categoría seleccionada.</p>
                    <a href="@Url.Action("Index", new { categoria = "todas" })" class="btn btn-primary">
                        Ver todos los productos
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<!-- ✅ MODAL PARA MOSTRAR LÍMITE ALCANZADO -->
<div class="modal fade" id="modalLimiteAlcanzado" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Límite de Productos Alcanzado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="mensaje-limite-content">
                    <!-- Contenido dinámico -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
                <a href="@Url.Action("VerCarrito")" class="btn btn-primary">
                    Ver carrito actual
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // ✅ VARIABLES GLOBALES PARA LÍMITES CORREGIDAS
    let limitesActuales = {
        productosActivos: 0,        // ✅ NOMBRE CORRECTO
        limite: 3,
        disponibles: 3,
        productosEnCarritos: 0,     // ✅ NOMBRE CORRECTO
        totalOcupados: 0,
        permitido: true,
        mensaje: ""
    };

    // ✅ FUNCIÓN PARA CARGAR LÍMITES CON NOMBRES CORREGIDOS
    async function cargarEstadoUnificado() {
        try {
            const response = await fetch('@Url.Action("ObtenerLimitesProductos")');
            const data = await response.json();
            
            console.log('[DEBUG] Datos recibidos:', data);
            
            // ✅ USAR NOMBRES CORRECTOS DE LAS PROPIEDADES
            const productosActivos = data.productosActivos || 0;        // ✅ CORREGIDO
            const productosCarritos = data.productosEnCarritos || 0;    // ✅ CORREGIDO
            const disponibles = data.disponibles || 0;
            const limite = data.limite || 3;
            const totalOcupados = productosActivos + productosCarritos;
            
            // ✅ ACTUALIZAR VARIABLES GLOBALES
            limitesActuales = {
                productosActivos: productosActivos,
                limite: limite,
                disponibles: disponibles,
                productosEnCarritos: productosCarritos,
                totalOcupados: totalOcupados,
                permitido: data.permitido || disponibles > 0,
                mensaje: data.mensaje || ""
            };
            
            // ✅ ACTUALIZAR INTERFAZ
            document.getElementById('disponibles-count').textContent = disponibles;
            document.getElementById('activos-count').textContent = productosActivos + '/' + limite;
            document.getElementById('carritos-count').textContent = productosCarritos;
            document.getElementById('limite-info').textContent = totalOcupados + '/' + limite;
            
            // ✅ MOSTRAR/OCULTAR Y CAMBIAR COLOR SEGÚN ESTADO
            const estadoElement = document.getElementById('estado-unificado');
            
            if (totalOcupados > 0) {
                estadoElement.style.display = 'block';
                
                if (disponibles === 0) {
                    estadoElement.className = 'alert alert-danger';
                    // ✅ DESHABILITAR TODOS LOS BOTONES
                    document.querySelectorAll('.btn-seleccionar').forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-ban"></i> Límite Alcanzado';
                        btn.className = 'btn-seleccionar btn-secondary';
                    });
                } else if (disponibles <= 1) {
                    estadoElement.className = 'alert alert-warning';
                    // ✅ MANTENER BOTONES HABILITADOS PERO CON WARNING
                    document.querySelectorAll('.btn-seleccionar').forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Último espacio';
                        btn.className = 'btn-seleccionar btn-warning';
                    });
                } else {
                    estadoElement.className = 'alert alert-info';
                    // ✅ BOTONES NORMALES
                    document.querySelectorAll('.btn-seleccionar').forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-cog"></i> Personalizar';
                        btn.className = 'btn-seleccionar';
                    });
                }
            } else {
                // ✅ OCULTAR CUANDO NO HAY PRODUCTOS
                estadoElement.style.display = 'none';
                // ✅ BOTONES NORMALES
                document.querySelectorAll('.btn-seleccionar').forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cog"></i> Personalizar';
                    btn.className = 'btn-seleccionar';
                });
            }
            
            console.log('[DEBUG] Estado unificado actualizado:', limitesActuales);
        } catch (error) {
            console.error('Error al cargar estado unificado:', error);
        }
    }

    // ✅ FUNCIÓN PARA VALIDAR Y SELECCIONAR PRODUCTO
    async function validarYSeleccionar(productoId) {
        // Recargar límites antes de validar
        await cargarEstadoUnificado();

        if (limitesActuales.disponibles === 0) {
            // Mostrar modal de límite alcanzado
            mostrarModalLimite();
            return false;
        }

        // Si hay espacio disponible, continuar con la selección
        window.location.href = '@Url.Action("IniciarPersonalizacion")?id=' + productoId;
    }

    // ✅ FUNCIÓN PARA MOSTRAR MODAL DE LÍMITE
    function mostrarModalLimite() {
        const { productosActivos, limite, productosEnCarritos, totalOcupados } = limitesActuales;
        
        document.getElementById('mensaje-limite-content').innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-info-circle"></i> Estado actual:</h6>
                <ul>
                    <li>Productos en pedidos activos: <strong>${productosActivos}/${limite}</strong></li>
                    <li>Productos en carritos (ambos): <strong>${productosEnCarritos}</strong></li>
                    <li>Total productos: <strong>${totalOcupados}/${limite}</strong></li>
                </ul>
                <p>Debes esperar a que se entreguen tus pedidos pendientes o procesar tu carrito actual para poder personalizar más productos.</p>
                <p><small class="text-muted">Los límites se aplican conjuntamente a personalización y recomendación IA.</small></p>
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('modalLimiteAlcanzado'));
        modal.show();
    }

    // ✅ ESCUCHAR CAMBIOS EN CARRITOS
    window.addEventListener('storage', function (e) {
        if (e.key === 'carritosActualizados' || e.key === 'carritoActualizado') {
            console.log('[DEBUG] Carritos actualizados globalmente, recargando límites...');
            cargarEstadoUnificado();
        }
    });

    // ✅ INICIALIZAR AL CARGAR LA PÁGINA
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstadoUnificado();
        
        // Recargar cuando se hace focus en la página
        window.addEventListener('focus', cargarEstadoUnificado);
    });
</script>
}

@functions {
    public string GetCategoryIcon(string category)
    {
        return category.ToLower() switch
        {
            "pizza" => "fas fa-pizza-slice",
            "cerveza" => "fas fa-beer",
            "cocteles" => "fas fa-cocktail",
            "bebidas" => "fas fa-glass-whiskey",
            "promo" => "fas fa-percentage",
            "sánduches" or "sanduches" => "fas fa-hamburger",
            "shot" => "fas fa-wine-glass-alt",
            "picadas" => "fas fa-cheese",
            _ => "fas fa-tag"
        };
    }
}