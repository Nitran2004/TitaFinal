@model IEnumerable<ProyectoIdentity.Models.Tarea>

<h2>Lista de Tareas</h2>

<a asp-action="Create" class="btn btn-primary" style="margin-bottom: 20px;">Crear Nueva Tarea</a>
<a class="btn btn-primary" asp-action="VerProductividadTareas">Ver Productividad de Todas las Tareas</a>
<a asp-action="ProductividadPorProyecto" class="btn btn-success">Productividad por Proyectos</a>
<button class="btn btn-info" onclick="calcularTareasCompletadas()">Calcular Tareas Completadas</button>
<a asp-action="ReporteRetraso" class="btn btn-info" style="margin-bottom: 20px;">Reporte de Tareas Retrasadas</a>

<form asp-action="Index" asp-controller="Tareas" method="get" onsubmit="setTimeout(calcularTareasCompletadas, 100)">
    <div class="form-row">
        <div class="col-md-3">
            <label for="fechaInicio">Fecha de Inicio:</label>
            <input type="date" class="form-control" id="fechaInicio" name="fechaInicio"
                   value="@((ViewData["fechaInicio"] as DateTime?)?.ToString("yyyy-MM-dd"))" required>
        </div>
        <div class="col-md-3">
            <label for="fechaFin">Fecha de Fin:</label>
            <input type="date" class="form-control" id="fechaFin" name="fechaFin"
                   value="@((ViewData["fechaFin"] as DateTime?)?.ToString("yyyy-MM-dd"))" required>
        </div>
        <div class="col-md-3">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary btn-block">Filtrar</button>
        </div>
    </div>
</form>


<table class="table table-striped">
    <thead>
        <tr>
            <th>Tarea</th>
            <th>FechadeInicio</th>
            <th>Empleado</th>
            <th>Proyecto</th>
            <th>Prioridad</th>
            <th>Tiempo Estimado (Horas)</th>
            <th>Tiempo Utilizado (Horas)</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var tarea in Model)
        {
            <tr>
                <td>@tarea.Nombredelatarea</td>
                <td>@tarea.FechadeInicio</td>
                <td>@tarea.Empleado.Name @tarea.Empleado.LastName</td>
                <td>@tarea.Proyecto.Name</td>
                <td>
                    @if (tarea.Prioridad == 3)
                    {
                        <span>Alta</span>
                    }
                    else if (tarea.Prioridad == 2)
                    {
                        <span>Media</span>
                    }
                    else
                    {
                        <span>Baja</span>
                    }
                </td>
                <td>@tarea.TiempoEstimado</td>
                <td>@tarea.TiempoUtilizado</td>
                <td>@tarea.EstadoProgreso</td>
                <td>
                    <!-- Botón para Ver Histórico (Color azul) -->
                    <div class="btn-group mb-2" role="group" aria-label="Actions">
                        <a asp-action="HistoricoProductividad" asp-route-empleadoId="@tarea.EmpleadoId" class="btn btn-primary btn-sm">
                            Ver Histórico
                        </a>
                    </div>

                    <!-- Botón para Editar (Color amarillo) -->
                    <div class="btn-group mb-2" role="group" aria-label="Actions">
                        <a asp-action="Edit" asp-route-id="@tarea.Id" class="btn btn-warning btn-sm">Editar</a>
                    </div>

                    <!-- Botón para Detalles (Color verde) -->
                    <div class="btn-group mb-2" role="group" aria-label="Actions">
                        <a asp-action="Details" asp-route-id="@tarea.Id" class="btn btn-success btn-sm">Detalles</a>
                    </div>

                    <!-- Botón para Eliminar (Color rojo) -->
                    <div class="btn-group mb-2" role="group" aria-label="Actions">
                        <a asp-action="Delete" asp-route-id="@tarea.Id" class="btn btn-danger btn-sm">Eliminar</a>
                    </div>

                    <!-- Formulario para Calcular Productividad (Color azul claro) -->
                    <div class="mt-2">
                        <form asp-action="CalcularProductividad" method="post">
                            <input type="hidden" name="empleadoId" value="@tarea.EmpleadoId" />
                            <button type="submit" class="btn btn-info btn-sm">
                                Calcular Productividad
                            </button>
                        </form>
                    </div>
                </td>

            </tr>
        }
    </tbody>
</table>

<div id="resultadoProductividad" style="margin-top: 20px;">
@*     //<h4>Productividad Calculada: <span id="productividadTotal">-</span></h4>
 *@    <h4>Tareas Completadas: <span id="tareasCompletadas">0</span></h4>

</div>

<script>
    function obtenerPbase(prioridad) {
        switch (prioridad) {
            case 3: return 3; // Alta
            case 2: return 2; // Media
            case 1: return 1; // Baja
            default: return 0;
        }
    }

//     function calcularProductividad(prioridad, tiempoEstimado, tiempoUtilizado) {
//         const Pbase = obtenerPbase(prioridad);
//         let Pfinal;

//         if (tiempoUtilizado > tiempoEstimado) {
//             Pfinal = Pbase - 0.5;
// //} else if (tiempoUtilizado < tiempoEstimado) {
//             Pfinal = Pbase + 0.5;
//         } else {
//             Pfinal = Pbase;
//         }

//         document.getElementById("productividadTotal").innerText = Pfinal;
   // }
    function calcularTareasCompletadas() {
        const filas = document.querySelectorAll("tbody tr");
        let completadas = 0;

        filas.forEach(fila => {
            const estado = fila.querySelector("td:nth-child(8)").innerText.trim();
            if (estado === "Completada") {
                completadas++;
            }
        });

        document.getElementById("tareasCompletadas").innerText = completadas;
    }

</script>
